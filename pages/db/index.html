<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Getting Started with LPDS"><meta name=author content="Alexander Martinez Fajardo"><link href=https://squidfunk.github.io/mkdocs-material/pages/db/ rel=canonical><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.3.1, mkdocs-material-7.3.0"><title>Persisting our data - LPDS - Docs</title><link rel=stylesheet href=../../assets/stylesheets/main.8b42a75e.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.3f5d1f46.min.css><meta name=theme-color content=#02a6f2><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style><link rel=stylesheet href=../../css/styles.css><link rel=stylesheet href=../../css/dark-mode.css></head> <body dir=ltr data-md-color-scheme data-md-color-primary=light-blue data-md-color-accent=amber> <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#container-networking class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="LPDS - Docs" class="md-header__button md-logo" aria-label="LPDS - Docs" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> LPDS - Docs </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Persisting our data </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/alex00pep/dosing-site-tech-overview title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> alex00pep/dosing-site-tech-overview </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="LPDS - Docs" class="md-nav__button md-logo" aria-label="LPDS - Docs" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg> </a> LPDS - Docs </label> <div class=md-nav__source> <a href=https://github.com/alex00pep/dosing-site-tech-overview title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> alex00pep/dosing-site-tech-overview </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> Home </a> </li> <li class=md-nav__item> <a href=../ class=md-nav__link> Getting Started </a> </li> <li class=md-nav__item> <a href=../milestones/ class=md-nav__link> Goals and milestones </a> </li> <li class=md-nav__item> <a href=../reqs/ class=md-nav__link> Our application </a> </li> <li class=md-nav__item> <a href=../ui/ class=md-nav__link> User interface Prototypes </a> </li> <li class=md-nav__item> <a href=../browser/ class=md-nav__link> Browser support </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Persisting our data <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Persisting our data </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#container-networking class=md-nav__link> Container Networking </a> </li> <li class=md-nav__item> <a href=#starting-mysql class=md-nav__link> Starting MySQL </a> </li> <li class=md-nav__item> <a href=#connecting-to-mysql class=md-nav__link> Connecting to MySQL </a> </li> <li class=md-nav__item> <a href=#running-our-app-with-mysql class=md-nav__link> Running our App with MySQL </a> <nav class=md-nav aria-label="Running our App with MySQL"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#recap class=md-nav__link> Recap </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#docker-volumes class=md-nav__link> Docker volumes </a> <nav class=md-nav aria-label="Docker volumes"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#the-containers-filesystem class=md-nav__link> The Container's Filesystem </a> </li> <li class=md-nav__item> <a href=#container-volumes class=md-nav__link> Container Volumes </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../cloud/ class=md-nav__link> Deploying our application to Cloud </a> </li> <li class=md-nav__item> <a href=../billing/ class=md-nav__link> Agreement for billing and maintenance costs </a> </li> <li class=md-nav__item> <a href=../license/ class=md-nav__link> License </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#container-networking class=md-nav__link> Container Networking </a> </li> <li class=md-nav__item> <a href=#starting-mysql class=md-nav__link> Starting MySQL </a> </li> <li class=md-nav__item> <a href=#connecting-to-mysql class=md-nav__link> Connecting to MySQL </a> </li> <li class=md-nav__item> <a href=#running-our-app-with-mysql class=md-nav__link> Running our App with MySQL </a> <nav class=md-nav aria-label="Running our App with MySQL"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#recap class=md-nav__link> Recap </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#docker-volumes class=md-nav__link> Docker volumes </a> <nav class=md-nav aria-label="Docker volumes"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#the-containers-filesystem class=md-nav__link> The Container's Filesystem </a> </li> <li class=md-nav__item> <a href=#container-volumes class=md-nav__link> Container Volumes </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1>Persisting our data</h1> <p>Up to this point, we have been working with single container apps. But, we now want to add MySQL to the application stack. The following question often arises - "Where will MySQL run? Install it in the same container or run it separately?" In general, <strong>each container should do one thing and do it well.</strong> A few reasons:</p> <ul> <li>There's a good chance you'd have to scale APIs and front-ends differently than databases.</li> <li>Separate containers let you version and update versions in isolation.</li> <li>While you may use a container for the database locally, you may want to use a managed service for the database in production. You don't want to ship your database engine with your app then.</li> <li>Running multiple processes will require a process manager (the container only starts one process), which adds complexity to container startup/shutdown.</li> </ul> <h2 id=container-networking>Container Networking<a class=headerlink href=#container-networking title="Permanent link">&para;</a></h2> <p>Remember that containers, by default, run in isolation and don't know anything about other processes or containers on the same machine. So, how do we allow one container to talk to another? The answer is <strong>networking</strong>. Now, you don't have to be a network engineer (hooray!). Simply remember this rule...</p> <blockquote> <p>If two containers are on the same network, they can talk to each other. If they aren't, they can't.</p> </blockquote> <h2 id=starting-mysql>Starting MySQL<a class=headerlink href=#starting-mysql title="Permanent link">&para;</a></h2> <p>There are two ways to put a container on a network: 1) Assign it at start or 2) connect an existing container. For now, we will create the network first and attach the MySQL container at startup.</p> <ol> <li> <p>Create the network.</p> <div class=highlight><pre><span></span><code>docker network create todo-app
</code></pre></div> </li> <li> <p>Start a MySQL container and attach it to the network. We're also going to define a few environment variables that the database will use to initialize the database (see the "Environment Variables" section in the <a href=https://hub.docker.com/_/mysql/ >MySQL Docker Hub listing</a>).</p> <div class=highlight><pre><span></span><code>docker run -d <span class=se>\</span>
    --network todo-app --network-alias mysql <span class=se>\</span>
    -v todo-mysql-data:/var/lib/mysql <span class=se>\</span>
    -e <span class=nv>MYSQL_ROOT_PASSWORD</span><span class=o>=</span>secret <span class=se>\</span>
    -e <span class=nv>MYSQL_DATABASE</span><span class=o>=</span>todos <span class=se>\</span>
    mysql:5.7
</code></pre></div> <p>If you are using PowerShell then use this command.</p> <div class=highlight><pre><span></span><code><span class=n>docker</span> <span class=n>run</span> <span class=n>-d</span> <span class=p>`</span>
    <span class=p>-</span><span class=n>-network</span> <span class=n>todo-app</span> <span class=p>-</span><span class=n>-network-alias</span> <span class=n>mysql</span> <span class=p>`</span>
    <span class=n>-v</span> <span class=n>todo-mysql-data</span><span class=err>:</span><span class=p>/</span><span class=n>var</span><span class=p>/</span><span class=n>lib</span><span class=p>/</span><span class=n>mysql</span> <span class=p>`</span>
    <span class=n>-e</span> <span class=n>MYSQL_ROOT_PASSWORD</span><span class=p>=</span><span class=n>secret</span> <span class=p>`</span>
    <span class=n>-e</span> <span class=n>MYSQL_DATABASE</span><span class=p>=</span><span class=n>todos</span> <span class=p>`</span>
    <span class=n>mysql</span><span class=err>:</span><span class=n>5</span><span class=p>.</span><span class=n>7</span>
</code></pre></div> <p>You'll also see we specified the <code>--network-alias</code> flag. We'll come back to that in just a moment.</p> <div class="admonition info"> <p class=admonition-title>Pro-tip</p> <p>You'll notice we're using a volume named <code>todo-mysql-data</code> here and mounting it at <code>/var/lib/mysql</code>, which is where MySQL stores its data. However, we never ran a <code>docker volume create</code> command. Docker recognizes we want to use a named volume and creates one automatically for us.</p> </div> <div class="admonition info"> <p class=admonition-title>Troubleshooting</p> <p>If you see a <code>docker: no matching manifest</code> error, it's because you're trying to run the container in a different architecture than amd64, which is the only supported architecture for the mysql image at the moment. To solve this add the flag <code>--platform linux/amd64</code> in the previous command. So your new command should look like this:</p> </div> <div class=highlight><pre><span></span><code>docker run -d <span class=se>\</span>
    --network todo-app --network-alias mysql --platform linux/amd64 <span class=se>\</span>
    -v todo-mysql-data:/var/lib/mysql <span class=se>\</span>
    -e <span class=nv>MYSQL_ROOT_PASSWORD</span><span class=o>=</span>secret <span class=se>\</span>
    -e <span class=nv>MYSQL_DATABASE</span><span class=o>=</span>todos <span class=se>\</span>
    mysql:5.7
</code></pre></div> </li> <li> <p>To confirm we have the database up and running, connect to the database and verify it connects.</p> <div class=highlight><pre><span></span><code>docker <span class=nb>exec</span> -it &lt;mysql-container-id&gt; mysql -p
</code></pre></div> <p>When the password prompt comes up, type in <strong>secret</strong>. In the MySQL shell, list the databases and verify you see the <code>todos</code> database.</p> <div class=highlight><pre><span></span><code>mysql&gt; SHOW DATABASES;
</code></pre></div> <p>You should see output that looks like this:</p> <div class=highlight><pre><span></span><code>+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
| todos              |
+--------------------+
5 rows in set (0.00 sec)
</code></pre></div> <p>Hooray! We have our <code>todos</code> database and it's ready for us to use!</p> <p>To exit the sql terminal type <code>exit</code> in the terminal.</p> </li> </ol> <h2 id=connecting-to-mysql>Connecting to MySQL<a class=headerlink href=#connecting-to-mysql title="Permanent link">&para;</a></h2> <p>Now that we know MySQL is up and running, let's use it! But, the question is... how? If we run another container on the same network, how do we find the container (remember each container has its own IP address)?</p> <p>To figure it out, we're going to make use of the <a href=https://github.com/nicolaka/netshoot>nicolaka/netshoot</a> container, which ships with a <em>lot</em> of tools that are useful for troubleshooting or debugging networking issues.</p> <ol> <li> <p>Start a new container using the nicolaka/netshoot image. Make sure to connect it to the same network.</p> <div class=highlight><pre><span></span><code>docker run -it --network todo-app nicolaka/netshoot
</code></pre></div> </li> <li> <p>Inside the container, we're going to use the <code>dig</code> command, which is a useful DNS tool. We're going to look up the IP address for the hostname <code>mysql</code>.</p> <div class=highlight><pre><span></span><code>dig mysql
</code></pre></div> <p>And you'll get an output like this...</p> <div class=highlight><pre><span></span><code>; &lt;&lt;&gt;&gt; DiG 9.14.1 &lt;&lt;&gt;&gt; mysql
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 32162
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0

;; QUESTION SECTION:
;mysql.             IN  A

;; ANSWER SECTION:
mysql.          600 IN  A   172.23.0.2

;; Query time: 0 msec
;; SERVER: 127.0.0.11#53(127.0.0.11)
;; WHEN: Tue Oct 01 23:47:24 UTC 2019
;; MSG SIZE  rcvd: 44
</code></pre></div> <p>In the "ANSWER SECTION", you will see an <code>A</code> record for <code>mysql</code> that resolves to <code>172.23.0.2</code> (your IP address will most likely have a different value). While <code>mysql</code> isn't normally a valid hostname, Docker was able to resolve it to the IP address of the container that had that network alias (remember the <code>--network-alias</code> flag we used earlier?).</p> <p>What this means is... our app only simply needs to connect to a host named <code>mysql</code> and it'll talk to the database! It doesn't get much simpler than that!</p> </li> </ol> <h2 id=running-our-app-with-mysql>Running our App with MySQL<a class=headerlink href=#running-our-app-with-mysql title="Permanent link">&para;</a></h2> <p>The todo app supports the setting of a few environment variables to specify MySQL connection settings. They are:</p> <ul> <li><code>MYSQL_HOST</code> - the hostname for the running MySQL server</li> <li><code>MYSQL_USER</code> - the username to use for the connection</li> <li><code>MYSQL_PASSWORD</code> - the password to use for the connection</li> <li><code>MYSQL_DB</code> - the database to use once connected</li> </ul> <div class="admonition warning setting connection settings via env vars"> <p class=admonition-title>Warning</p> <p>While using env vars to set connection settings is generally ok for development, it is <strong>HIGHLY DISCOURAGED</strong> when running applications in production. Diogo Monica, the former lead of security at Docker, <a href=https://diogomonica.com/2017/03/27/why-you-shouldnt-use-env-variables-for-secret-data/ >wrote a fantastic blog post</a> explaining why.</p> <p>A more secure mechanism is to use the secret support provided by your container orchestration framework. In most cases, these secrets are mounted as files in the running container. You'll see many apps (including the MySQL image and the todo app) also support env vars with a <code>_FILE</code> suffix to point to a file containing the variable.</p> <p>As an example, setting the <code>MYSQL_PASSWORD_FILE</code> var will cause the app to use the contents of the referenced file as the connection password. Docker doesn't do anything to support these env vars. Your app will need to know to look for the variable and get the file contents.</p> </div> <p>With all of that explained, let's start our dev-ready container!</p> <ol> <li> <p>We'll specify each of the environment variables above, as well as connect the container to our app network.</p> <div class=highlight><pre><span></span><code>docker run -dp <span class=m>3000</span>:3000 <span class=se>\</span>
  -w /app -v <span class=s2>&quot;</span><span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span><span class=s2>:/app&quot;</span> <span class=se>\</span>
<span class=hll>  --network todo-app <span class=se>\</span>
</span><span class=hll>  -e <span class=nv>MYSQL_HOST</span><span class=o>=</span>mysql <span class=se>\</span>
</span><span class=hll>  -e <span class=nv>MYSQL_USER</span><span class=o>=</span>root <span class=se>\</span>
</span><span class=hll>  -e <span class=nv>MYSQL_PASSWORD</span><span class=o>=</span>secret <span class=se>\</span>
</span><span class=hll>  -e <span class=nv>MYSQL_DB</span><span class=o>=</span>todos <span class=se>\</span>
</span>  node:12-alpine <span class=se>\</span>
  sh -c <span class=s2>&quot;yarn install &amp;&amp; yarn run dev&quot;</span>
</code></pre></div> <p>If you updated your docker file in the Bind Mount section of the tutorial use the updated command:</p> <div class=highlight><pre><span></span><code>docker run -dp <span class=m>3000</span>:3000 <span class=se>\</span>
  -w /app -v <span class=s2>&quot;</span><span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span><span class=s2>:/app&quot;</span> <span class=se>\</span>
<span class=hll>  --network todo-app <span class=se>\</span>
</span><span class=hll>  -e <span class=nv>MYSQL_HOST</span><span class=o>=</span>mysql <span class=se>\</span>
</span><span class=hll>  -e <span class=nv>MYSQL_USER</span><span class=o>=</span>root <span class=se>\</span>
</span><span class=hll>  -e <span class=nv>MYSQL_PASSWORD</span><span class=o>=</span>secret <span class=se>\</span>
</span><span class=hll>  -e <span class=nv>MYSQL_DB</span><span class=o>=</span>todos <span class=se>\</span>
</span>  node:12-alpine <span class=se>\</span>
  sh -c <span class=s2>&quot;apk --no-cache --virtual build-dependencies add python2 make g++ &amp;&amp; yarn install &amp;&amp; yarn run dev&quot;</span>
</code></pre></div> <p>If you are using PowerShell then use this command.</p> <div class=highlight><pre><span></span><code><span class=n>docker</span> <span class=n>run</span> <span class=n>-dp</span> <span class=n>3000</span><span class=err>:</span><span class=n>3000</span> <span class=p>`</span>
  <span class=n>-w</span> <span class=p>/</span><span class=n>app</span> <span class=n>-v</span> <span class=s2>&quot;</span><span class=p>$(</span><span class=n>pwd</span><span class=p>)</span><span class=s2>:/app&quot;</span> <span class=p>`</span>
<span class=hll>  <span class=p>-</span><span class=n>-network</span> <span class=n>todo-app</span> <span class=p>`</span>
</span><span class=hll>  <span class=n>-e</span> <span class=n>MYSQL_HOST</span><span class=p>=</span><span class=n>mysql</span> <span class=p>`</span>
</span><span class=hll>  <span class=n>-e</span> <span class=n>MYSQL_USER</span><span class=p>=</span><span class=n>root</span> <span class=p>`</span>
</span><span class=hll>  <span class=n>-e</span> <span class=n>MYSQL_PASSWORD</span><span class=p>=</span><span class=n>secret</span> <span class=p>`</span>
</span><span class=hll>  <span class=n>-e</span> <span class=n>MYSQL_DB</span><span class=p>=</span><span class=n>todos</span> <span class=p>`</span>
</span>  <span class=n>node</span><span class=err>:</span><span class=n>12-alpine</span> <span class=p>`</span>
  <span class=n>sh</span> <span class=n>-c</span> <span class=s2>&quot;yarn install &amp;&amp; yarn run dev&quot;</span>
</code></pre></div> </li> <li> <p>If we look at the logs for the container (<code>docker logs &lt;container-id&gt;</code>), we should see a message indicating it's using the mysql database.</p> <div class=highlight><pre><span></span><code># Previous log messages omitted
$ nodemon src/index.js
[nodemon] 1.19.2
[nodemon] to restart at any time, enter `rs`
[nodemon] watching dir(s): *.*
[nodemon] starting `node src/index.js`
<span class=hll>Connected to mysql db at host mysql
</span>Listening on port 3000
</code></pre></div> </li> <li> <p>Open the app in your browser and add a few items to your todo list.</p> </li> <li> <p>Connect to the mysql database and prove that the items are being written to the database. Remember, the password is <strong>secret</strong>.</p> <div class=highlight><pre><span></span><code>docker <span class=nb>exec</span> -it &lt;mysql-container-id&gt; mysql -p todos
</code></pre></div> <p>And in the mysql shell, run the following:</p> <div class=highlight><pre><span></span><code>mysql&gt; select * from todo_items;
+--------------------------------------+--------------------+-----------+
| id                                   | name               | completed |
+--------------------------------------+--------------------+-----------+
| c906ff08-60e6-44e6-8f49-ed56a0853e85 | Do amazing things! |         0 |
| 2912a79e-8486-4bc3-a4c5-460793a575ab | Be awesome!        |         0 |
+--------------------------------------+--------------------+-----------+
</code></pre></div> <p>Obviously, your table will look different because it has your items. But, you should see them stored there!</p> </li> </ol> <p>If you take a quick look at the Docker Dashboard, you'll see that we have two app containers running. But, there's no real indication that they are grouped together in a single app. We'll see how to make that better shortly!</p> <p><img alt="Docker Dashboard showing two ungrouped app containers" src=dashboard-multi-container-app.png></p> <h3 id=recap>Recap<a class=headerlink href=#recap title="Permanent link">&para;</a></h3> <p>At this point, we have an application that now stores its data in an external database running in a separate container. We learned a little bit about container networking and saw how service discovery can be performed using DNS.</p> <h2 id=docker-volumes>Docker volumes<a class=headerlink href=#docker-volumes title="Permanent link">&para;</a></h2> <p>In containerized applications, the data by default is being wiped clean every single time we launch the container. Why is this? Let's dive into how the container is working.</p> <h3 id=the-containers-filesystem>The Container's Filesystem<a class=headerlink href=#the-containers-filesystem title="Permanent link">&para;</a></h3> <p>When a container runs, it uses the various layers from an image for its filesystem. Each container also gets its own "scratch space" to create/update/remove files. Any changes won't be seen in another container, <em>even if</em> they are using the same image.</p> <h3 id=container-volumes>Container Volumes<a class=headerlink href=#container-volumes title="Permanent link">&para;</a></h3> <p>With the previous experiment, we saw that each container starts from the image definition each time it starts. While containers can create, update, and delete files, those changes are lost when the container is removed and all changes are isolated to that container. With volumes, we can change all of this.</p> <p><a href=https://docs.docker.com/storage/volumes/ >Volumes</a> provide the ability to connect specific filesystem paths of the container back to the host machine. If a directory in the container is mounted, changes in that directory are also seen on the host machine. If we mount that same directory across container restarts, we'd see the same files.</p> <p>So far, we talked about and used a <strong>named volume</strong> to persist the data in our database. Named volumes are great if we simply want to store data, as we don't have to worry about <em>where</em> the data is stored.</p> <p>With <strong>bind mounts</strong>, we control the exact mountpoint on the host. We can use this to persist data, but is often used to provide additional data into containers. When working on an application, we can use a bind mount to mount our source code into the container to let it see code changes, respond, and let us see the changes right away.</p> <p>For Node-based applications, <a href=https://npmjs.com/package/nodemon>nodemon</a> is a great tool to watch for file changes and then restart the application. There are equivalent tools in most other languages and frameworks.</p> </article> </div> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../browser/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Browser support" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> Browser support </div> </div> </a> <a href=../cloud/ class="md-footer__link md-footer__link--next" aria-label="Next: Deploying our application to Cloud" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Deploying our application to Cloud </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2020 Alexander Martinez Fajardo </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.f8263e09.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "version": null}</script> <script src=../../assets/javascripts/bundle.4fc53ad4.min.js></script> </body> </html>